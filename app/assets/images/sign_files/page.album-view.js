if(!Array.prototype.every){Array.prototype.every=function(fun){var len=this.length>>>0;if(typeof fun!="function"){throw new TypeError}var thisp=arguments[1];for(var i=0;i<len;i++){if(i in this&&!fun.call(thisp,this[i],i,this)){return false}}return true}}if(!Array.prototype.filter){Array.prototype.filter=function(fun){var len=this.length>>>0;if(typeof fun!="function"){throw new TypeError}var res=[];var thisp=arguments[1];for(var i=0;i<len;i++){if(i in this){var val=this[i];if(fun.call(thisp,val,i,this)){res.push(val)}}}return res}}if(!Array.prototype.forEach){Array.prototype.forEach=function(fun){var len=this.length>>>0;if(typeof fun!="function"){throw new TypeError}var thisp=arguments[1];for(var i=0;i<len;i++){if(i in this){fun.call(thisp,this[i],i,this)}}}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(elt){var len=this.length>>>0;var from=Number(arguments[1])||0;from=from<0?Math.ceil(from):Math.floor(from);if(from<0){from+=len}for(;from<len;from++){if(from in this&&this[from]===elt){return from}}return-1}}if(!Array.prototype.lastIndexOf){Array.prototype.lastIndexOf=function(elt){var len=this.length;var from=Number(arguments[1]);if(isNaN(from)){from=len-1}else{from=from<0?Math.ceil(from):Math.floor(from);if(from<0){from+=len}else if(from>=len){from=len-1}}for(;from>-1;from--){if(from in this&&this[from]===elt){return from}}return-1}}if(!Array.prototype.map){Array.prototype.map=function(fun){var len=this.length>>>0;if(typeof fun!="function"){throw new TypeError}var res=new Array(len);var thisp=arguments[1];for(var i=0;i<len;i++){if(i in this){res[i]=fun.call(thisp,this[i],i,this)}}return res}}if(!Array.prototype.reduce){Array.prototype.reduce=function(fun){var len=this.length>>>0;var rv;if(typeof fun!="function"){throw new TypeError}if(len===0&&arguments.length==1){throw new TypeError}var i=0;if(arguments.length>=2){rv=arguments[1]}else{do{if(i in this){rv=this[i++];break}if(++i>=len){throw new TypeError}}while(true)}for(;i<len;i++){if(i in this){rv=fun.call(null,rv,this[i],i,this)}}return rv}}if(!Array.prototype.reduceRight){Array.prototype.reduceRight=function(fun){var len=this.length>>>0;var rv;if(typeof fun!="function"){throw new TypeError}if(len===0&&arguments.length===1){throw new TypeError}var i=len-1;if(arguments.length>=2){rv=arguments[1]}else{do{if(i in this){rv=this[i--];break}if(--i<0){throw new TypeError}}while(true)}for(;i>=0;i--){if(i in this){rv=fun.call(null,rv,this[i],i,this)}}return rv}}if(!Array.prototype.some){Array.prototype.some=function(fun){var i=0;var len=this.length>>>0;if(typeof fun!="function"){throw new TypeError}var thisp=arguments[1];for(;i<len;i++){if(i in this&&fun.call(thisp,this[i],i,this)){return true}}return false}}(function(){var make_generic=function(static_holder,dynamic_holder,method_name){var dynamic_method=dynamic_holder[method_name];if(typeof dynamic_method!="function"&&static_holder[method_name]){return false}static_holder[method_name]=function(){return dynamic_method.call.apply(dynamic_method,arguments)};return static_holder[method_name]};["concat","every","filter","forEach","indexOf","lastIndexOf","map","reduce","reduceRight","some","pop"].forEach(function($1){make_generic(Array,Array.prototype,$1)});if(typeof[].unshift()=="undefined"){var _unshift=Array.prototype.unshift;Array.prototype.unshift=function(){_unshift.apply(this,arguments);return this.length}}})();if(!Function.prototype.bind){Function.prototype.bind=function(context){var that=this;var args=[];for(var j=0,l=arguments.length;j<l;j++){args.push(arguments[j])}return function(){var args2=[];for(var j=0,l=arguments.length;j<l;j++){args2.push(arguments[j])}return that.call.apply(that,args.concat(args2))}}}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}}Array.shuffle=function(arr){var a=[arr[0]];for(var j=1,l=arr.length;j<l;j++){var i=Math.round(Math.random()*j);a[j]=a[i];a[i]=arr[j]}return a};(function($,win,doc){var $doc=$(doc);var normalizeSpaceRegexp=/[\s\xA0]{2,}/g;var $ta=$("<textarea/>");var Utils={};Utils.plural=function(num,forms,withoutNumber){var res=2;var num_10=num%10;var num_100=num%100;if(num===0){if(forms[3]){return forms[3]}}else{if(num_100<5||num_100>20){if(num_10===1){res=0}else{if(num_10>=2&&num_10<=4){res=1}}}}if(withoutNumber){return forms[res]}else{return num+" "+forms[res]}};Utils.normalizeSpace=function(str){return $.trim(str.replace(normalizeSpaceRegexp," "))};Utils.nc=function(prefix){return this.generateId(prefix)};Utils.generateId=function(prefix){return(prefix||"")+((new Date).getTime()+Math.round(Math.random()*1e4))};Utils.unique=function(array){var newArray=[];for(var i=0;i<array.length;i++){var element=array[i];if(newArray.indexOf(element)===-1){newArray.push(element)}}return newArray};Utils.capitalize=function(str){return str.charAt(0).toUpperCase()+str.substr(1).toLowerCase()};Utils.askPredicates=[];Utils.initPageUploadMessage=function(message,show_message_predicate){if(show_message_predicate){Utils.askPredicates.push(show_message_predicate)}win.onbeforeunload=win.onbeforeunload||function(evt){if(Utils.askPredicates.every(function(ask_check){return!ask_check()})){return}var e=evt||win.event;if(e){e.returnValue=message}return message}};Utils.serializeForm=function($form){var ar=$form.serializeArray();var obj={};var item;for(var i=0;i<ar.length;i++){item=ar[i];obj[item.name]=item.value}return obj};Utils.disableButton=function($input){$input.css("display","none").clone(true).insertAfter($input).attr("disabled","disabled").css("display","")};Utils.toArray=function(args){return Array.prototype.slice.call(args,0)};Utils.escape=function(str){return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")};Utils.unescape=function(str){var result=$ta.html(str||"").text();$ta.html("");return result};Utils.ellipsis=function(str,limit){if(!limit){limit=256}return str.length<limit?str:str.substring(0,limit-1)+"…"};Utils.buildQueryString=function(params){var query="";for(var name in params){if(typeof params[name]!==undefined){query+=(query?"&":"")+encodeURIComponent(name)+"="+encodeURIComponent(params[name])}}return query};Utils.buildUrl=function(scheme,hostAndPort,path,paramsMap){if(path.length===0||path.charAt(0)!="/"){path="/"+path}return scheme+"://"+hostAndPort+encodeURI(path)+"?"+this.buildQueryString(paramsMap)};Utils.appendUrlPathAndParams=function(url,path,queryParams){var sep="";if(url.charAt(url.length-1)!="/"){sep="/"}return url+sep+path+"?"+Utils.buildQueryString(queryParams)};Utils.getViewPort=function(){var doc_elem=doc.documentElement;var body=doc.getElementsByTagName("body")[0];if(typeof win.innerWidth!=="undefined"){return function(){return{w:win.innerWidth,h:win.innerHeight}}}if(typeof doc_elem!=="undefined"&&typeof doc_elem.clientWidth!=="undefined"&&doc_elem.clientWidth!==0){return function(){return{w:doc_elem.clientWidth,h:doc_elem.clientHeight}}}return function(){return{w:body.clientWidth,h:body.clientHeight}}}();Utils.getIncrementalIntervalGenerator=function(){return function(){var p0;var p1;var gen={reset:function(){p0=0;p1=1},get:function(){var n=p0+p1;p0=p1;p1=n;return p0<35?p0*100:3500}};gen.reset();return gen}()};if(!("Fotki"in win)){win.Fotki={}}Fotki.utils=Utils})(jQuery,window,document);(function($){var abs=Math.abs;var min=Math.min;var max=Math.max;var area=function(r){return r.width*r.height};var Utils={};Utils.getCenter=function(r){return{left:r.left+r.width/2,top:r.top+r.height/2}};Utils.intersect=function(r1,r2){var c1=r1.c||this.getCenter(r1);var c2=r2.c||this.getCenter(r2);return abs(c1.left-c2.left)<(r1.width+r2.width)/2&&abs(c1.top-c2.top)<(r1.height+r2.height)/2};Utils.getIntersection=function(r1,r2){var i={left:max(r1.left,r2.left),top:max(r1.top,r2.top)};i.width=min(r1.left+r1.width,r2.left+r2.width)-i.left;i.height=min(r1.top+r1.height,r2.top+r2.height)-i.top;if(i.width<=0||i.height<=0){return{left:0,top:0,width:0,height:0}}return i};Utils.getIntersectionRate=function(r1,r2){if(!this.intersect(r1,r2)){return 0}var i=this.getIntersection(r1,r2);var ai=area(i);return ai/min(area(r1),min(area(r2)))};if(!("Fotki"in window)){window.Fotki={}}Fotki.rect=Utils})(jQuery);(function($,Lego){if(!Lego)Lego=window.Lego={};Lego.messages=Lego.messages||{};Lego.message=function(id,text){return Lego.params.locale=="ru"?text:Lego.messages[id]||text}})(jQuery,window.Lego);(function(Lego){if(!Lego)Lego=window.Lego={};Lego.oframebust=function(whitelist){if(location==top.location)return;var domain=(location.search.match(/[&?]oframebust=([^&;]+)/)||[])[1];if(!domain)top.location=location;if(Lego.oframebustMatchDomain(whitelist,domain)){var iframe=document.createElement("iframe");iframe.style.position="absolute";iframe.style.left="-999px";iframe.style.width="1px";iframe.src="//"+domain+"/oframebust.html?"+encodeURIComponent(location.href);(function(){if(document.body&&document.body.firstChild){document.body.insertBefore(iframe,document.body.firstChild)}else{setTimeout(arguments.callee,0)}})();return}top.location=location}})(window.Lego);BEM.DOM.decl("b-form-button",{onSetMod:{js:function(){(this._href=this.domElem.attr("href"))&&this.isDisabled()&&this.domElem.removeAttr("href")},focused:{yes:function(){if(this.isDisabled())return false;this.bindTo("keydown",this._onKeyDown)},"":function(){this.unbindFrom("keydown")}},disabled:function(modName,modVal){this.elem("input").attr("disabled",modVal=="yes");this._href&&(modVal=="yes"?this.domElem.removeAttr("href"):this.domElem.attr("href",this._href))},pressed:function(modName,modVal){this.isDisabled()||this.trigger(modVal=="yes"?"press":"release")},"*":function(modName,modVal){if(this.isDisabled()&&"hovered pressed".indexOf(modName)>-1)return false;"hovered focused".indexOf(modName)>-1&&modVal==""&&this.delMod("pressed")}},isDisabled:function(){return this.hasMod("disabled","yes")},url:function(val){if(typeof val=="undefined"){return this._href}else{this._href=val;this.isDisabled()||this.domElem.attr("href",val);return this}},_onKeyDown:function(e){if(e.keyCode==13&&!this._keyDowned){this._keyDowned=true;this.setMod("pressed","yes").bindTo("keyup",function(){this.delMod("pressed").unbindFrom("keyup");delete this._keyDowned})}},_onClick:function(e){this.isDisabled()?e.preventDefault():this.afterCurrentEvent(function(){this.trigger("click")})}},{live:function(){var eventsToMods={mouseover:{name:"hovered",val:"yes"},mouseout:{name:"hovered"},mousedown:{name:"pressed",val:"yes"},mouseup:{name:"pressed"},focusin:{name:"focused",val:"yes"},focusout:{name:"focused"}};this.liveBindTo("leftclick",function(e){this._onClick(e)}).liveBindTo("mouseover mouseout mousedown mouseup focusin focusout",function(e){e.type=="mousedown"&&e.preventDefault();var mod=eventsToMods[e.type];this.setMod(mod.name,mod.val||"")})}});(function($){var min=Math.min;var max=Math.max;var tail_sizes={horiz:{width:7,height:14,min_top:7},vert:{width:14,height:7,min_left:7}};var classes={down:"b-popupa_direction_down",bottom:"b-popupa_direction_bottom",left:"b-popupa_direction_left",right:"b-popupa_direction_right"};var aligner={down:function(element,popup){var tail=tail_sizes.vert;return{popup:{left:min(element.left,element.left+element.width/2-tail.width/2-tail.min_left)+"px",top:element.top+element.height+tail.height+"px"},tail:{marginLeft:max(tail.min_left,(min(element.width,popup.width)-tail.width)/2)+"px",marginTop:-tail.height+"px"}}},right:function(element,popup){var tail=tail_sizes.horiz;return{popup:{left:element.left+element.width+tail.width+"px",top:min(element.top,element.top+element.height/2-tail.height/2-tail.min_top)+"px"},tail:{marginLeft:-tail.width+"px",marginTop:max(tail.min_top,(min(element.height,popup.height)-tail.height)/2)+"px"}}}};var Popup={};Popup.alignTo=function($popup,$elem){var offset=$elem.offset();var $tail=$(".js-tail",$popup);var $mode=$popup.find(".js-mode");var $parent=$elem.parent();var element={left:offset.left,top:offset.top,width:$elem.outerWidth(),height:$elem.outerHeight()};var popup={width:$popup.outerWidth(),height:$popup.outerHeight()};var popup_bottom=element.top+element.height+popup.height+tail_sizes.vert.height;var bottom=$parent.offset().top+$parent.outerHeight();var type=popup_bottom>bottom?"right":"down";$popup.bem("b-popupa").setMod("direction",type);Popup._clearDirection($mode);$mode.addClass(classes[type]);var align_to=aligner[type](element,popup);$popup.css(align_to.popup);$tail.css(align_to.tail)};Popup._clearDirection=function($popup){$popup.removeClass(classes.down).removeClass(classes.bottom).removeClass(classes.left).removeClass(classes.right)};if(!("Fotki"in window)){window.Fotki={}}if(!("help"in Fotki)){Fotki.help={}}Fotki.help.popup=Popup})(jQuery);(function($){var utils=Fotki.utils;var max_length=32;var UserModel=function(user_data,is_current){var label=user_data.label||user_data.title||user_data.login;this.first_letter=label.substring(0,1);this.rest=utils.ellipsis(label.substring(1),max_length-1);this.rest_with_me=this.rest;if(is_current){this.rest_with_me+=" (это я)"}this.full=label;this.login=user_data.login;this.user_page="/users/"+this.login;this.userpic=user_data.userpic};var TextModel=function(text,author){this.text=utils.ellipsis(text,max_length);this.full=text;this.note_page="/users/"+author.login+"/where/"+encodeURIComponent(this.full)};var Templates=function(){this.templates={}};Templates.prototype.setCurrentUserID=function(uid){this._current_uid=uid;return this};Templates.prototype.setAuthor=function(author){this._author=author;return this};Templates.prototype.init=function(name,data){return this._create(name,data,true)};Templates.prototype.create=function(name,data){return this._create(name,data,false)};Templates.prototype._create=function(name,data,single_instance){data=data||{};var blank=this._getBlank(name,single_instance);var model=this._getDataModel(data);return this._init(blank,model,data)};Templates.prototype._getBlank=function(name,single_instance){var template_class=".js-template.js-template-"+name;if(single_instance){return $(template_class).removeClass("g-hidden").detach()}if(!this.templates[name]){this.templates[name]=$(template_class).clone().removeClass("g-hidden")}return this.templates[name].clone()};Templates.prototype._getDataModel=function(data){if(data.text){return new TextModel(data.text,this._author)}else if(data.login){return new UserModel(data,data.uid==this._current_uid)}return{}};Templates.prototype._init=function(blank,model,data){var $target;var target;var raw_value;var value;var tagName;for(var key in model){value=model[key]||"";raw_value=value;value=utils.escape(value);if(key==="full"){blank.attr("title",raw_value);continue}$target=blank.find(".js-data-"+key);target=$target.get(0);if(!target){continue}tagName=target.tagName.toLowerCase();if(tagName==="img"){if(!value){$target.css("visibility","hidden")}else{$target.attr("src",raw_value)}}else if(tagName==="a"&&key==="user_page"){$target.attr("href",raw_value)}else if(tagName==="a"&&key==="note_page"){$target.attr("href",raw_value)}else{$target.html(value)}}blank.data("raw",data);return blank};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}if(!("Areas"in Fotki.Classes)){Fotki.Classes.Areas={}}Fotki.Classes.Areas.Templates=new Templates})(jQuery);(function($){var templ=Fotki.Classes.Areas.Templates;var Suggest=function(options){this._url="/actions/user-suggest.xml";this._min_length=1;this._me=["i","я","me","мы"];this.options=options;this._selected=null;this._prev_value="";this._cache={};this._lastXhr=null;this.$popup=$(".js-user-ballon").detach().appendTo(document.body);this.$input=$(".js-user",this.$popup);this.$suggest_popup=$(".js-user-suggest",this.$popup);this.$save_button=$(".js-suggest-save",this.element);this.$cancel_button=$(".js-suggest-cancel",this.element);this.$quick=$(".js-quick-links",this.element);this.events=$("<div/>");this._initButtons()};Suggest.prototype._initButtons=function(){var $input=this.$input;var $save=this.$save_button;var $cancel=this.$cancel_button;$input.bind("keypress",this._listenToKeyboard.bind(this));$input.bind("keyup",this._onInputChange.bind(this));this._updateSaveButton();$save.bind("click",this._onSave.bind(this));$cancel.bind("click",this._onCancel.bind(this));$(".js-quick-link",this.element).live("click",this._quickSet.bind(this))};Suggest.prototype._onInputChange=function(evt){var current_value=this.$input.val();if(current_value!==this._prev_value){this._force_user=true;this._updateSaveButton()}this._prev_value=current_value;if(evt&&evt.which==27){this._onCancel(evt)}};Suggest.prototype._quickSet=function(evt){var guess;evt.preventDefault();guess=$(evt.target).closest(".js-quick-link").data("guess");this._selected=guess.uid?this._convertUser(guess):this._convertText(guess.text);this.$input.val(this._selected.label);this._updateSaveButton();this.$save_button.find("input").focus();this._force_user=false};Suggest.prototype._onCancel=function(evt){if(evt){evt.preventDefault();evt.stopPropagation()}this._selected=null;this.close("suggest:cancel")};Suggest.prototype._onSave=function(evt){if(evt){evt.preventDefault();evt.stopPropagation()}this._updateSelected();this.close();Lego.cp(106,71390,"savetag.click")};Suggest.prototype._updateSelected=function(){var selected=this._selected;var label=this.$input.val();if(!selected){this._selected=selected=this._convertText(label);return}if(selected.label!==label){this._selected=selected=this._convertText(label)}};Suggest.prototype._listenToKeyboard=function(evt){if(evt.which==13&&!this._emptyInput()){this._onSave(evt)}};Suggest.prototype._emptyInput=function(){return $.trim(this.$input.val()).length===0};Suggest.prototype._updateSaveButton=function(){var $save=this.$save_button;if(this._emptyInput()){$save.bem("b-form-button").setMod("disabled","yes")}else{$save.bem("b-form-button").setMod("disabled",null)}};Suggest.prototype.show=function(data,element,guesses){if(!data){this.$input.val("")}else if(data.login){this.$input.val(data.title);this._selected=this._convertUser(data)}else if(data.text){this.$input.val(data.text);this._selected=this._convertText(data.text)}this.align(element);this._initAutocomplete();this._updateSaveButton();this._showQuickButtons(guesses);this.$popup.show();this.$input.focus();this._force_user=true;Lego.cp(106,71390,"savetag.show")};Suggest.prototype._showQuickButtons=function(guesses){var template_name;var guess;var $guess;var set_first;this.$quick.children().remove();guesses=(guesses||[]).slice(0);if(guesses.length===0){guesses.push(this.options.current_user)}for(var i=0;i<guesses.length;i++){set_first=false;guess=guesses[i];if(guess.uid){if(guess.uid==this.options.current_user.uid){template_name="suggest_quick_me";set_first=true}else{template_name="suggest_quick_user"}template_name=guess.uid==this.options.current_user.uid?"suggest_quick_me":"suggest_quick_user"}else{template_name="suggest_quick_text"}$guess=templ.create(template_name,guess);$guess.data("guess",guess);if(set_first){if(i>0){this.$quick.prepend(templ.create("suggest_quick_separator"))}this.$quick.prepend($guess)}else{if(i>0){this.$quick.append(templ.create("suggest_quick_separator"))}this.$quick.append($guess)}}};Suggest.prototype.align=function(element){Fotki.help.popup.alignTo(this.$popup,element)};Suggest.prototype._initAutocomplete=function(){this.$input.autocomplete({minLength:this._min_length,source:this._getUsers.bind(this),create:this._autocompleteCustomize.bind(this),select:this._onItemSelected.bind(this)})};Suggest.prototype._onItemSelected=function(evt,ui){this._force_user=false;this._selected=ui.item};Suggest.prototype._getUsers=function(request,callback){var cache=this._cache;var text=request.term;var text_low=text.toLowerCase();if(text in cache){callback(cache[text]);return}this._lastXhr=$.ajax({url:this._url,dataType:"json",data:{q:text},success:function(data,status,xhr){var current_user=this.options.current_user;var filtered=[];if(data){filtered=data}var converted=$.map(filtered,this._convertUser);if(converted.length>0){if(this._me.indexOf(text_low)>=0){converted=converted.filter(function(item){return item.uid!==current_user.uid});converted.unshift(this._convertUser(current_user))}converted.unshift(this._convertText(text))}cache[text]=converted;if(xhr===this._lastXhr){callback(converted)}}.bind(this)})};Suggest.prototype._convertUser=function(u){var label=u.title||u.login;return{label:label,login:u.login,title:u.title,uid:u.userId||u.uid,userpic:Fotki.utils.unescape(u.userpicSmall||u.userpic)}};Suggest.prototype._convertText=function(text){return{label:text,text:text}};Suggest.prototype._autocompleteCustomize=function(){var a=this.$input.data("autocomplete");var suggest=a._suggest;a._suggest=function(items){suggest.call(a,items);a.menu.element.zIndex(32701)};a._renderItem=function(ul,item){var $item;if(item.login){$item=templ.create("user_suggest_item",item)}else{$item=templ.create("text_suggest_item",item)}return $item.data("item.autocomplete",item).appendTo(ul)}.bind(this)};Suggest.prototype.close=function(trigger_event){this.hide();this.$input.autocomplete("destroy");trigger_event=trigger_event||"suggest:save";this.events.trigger(trigger_event,[this._selected,this._force_user])};Suggest.prototype.hide=function(){this.$suggest_popup.hide();this.$popup.hide()};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}Fotki.Classes.UserSuggest=Suggest})(jQuery);(function($){$.Jcrop=function(obj,opt){var options=$.extend({},$.Jcrop.defaults),docOffset,lastcurs,ie6mode=false;function px(n){return parseInt(n,10)+"px"}function cssClass(cl){return options.baseClass+"-"+cl}function supportsColorFade(){return $.fx.step.hasOwnProperty("backgroundColor")}function getPos(obj){var pos=$(obj).offset();return[pos.left,pos.top]}function mouseAbs(e){return[e.pageX-docOffset[0],e.pageY-docOffset[1]]}function setOptions(opt){if(typeof opt!=="object")opt={};options=$.extend(options,opt);$.each(["onChange","onSelect","onRelease","onDblClick"],function(i,e){if(typeof options[e]!=="function")options[e]=function(){}})}function startDragMode(mode,pos){docOffset=getPos($img);Tracker.setCursor(mode==="move"?mode:mode+"-resize");if(mode==="move"){return Tracker.activateHandlers(createMover(pos),doneSelect)}var fc=Coords.getFixed();var opp=oppLockCorner(mode);var opc=Coords.getCorner(oppLockCorner(opp));Coords.setPressed(Coords.getCorner(opp));Coords.setCurrent(opc);Tracker.activateHandlers(dragmodeHandler(mode,fc),doneSelect)}function dragmodeHandler(mode,f){return function(pos){if(!options.aspectRatio){switch(mode){case"e":pos[1]=f.y2;break;case"w":pos[1]=f.y2;break;case"n":pos[0]=f.x2;break;case"s":pos[0]=f.x2;break}}else{switch(mode){case"e":pos[1]=f.y+1;break;case"w":pos[1]=f.y+1;break;case"n":pos[0]=f.x+1;break;case"s":pos[0]=f.x+1;break}}Coords.setCurrent(pos);Selection.update()}}function createMover(pos){var lloc=pos;KeyManager.watchKeys();return function(pos){Coords.moveOffset([pos[0]-lloc[0],pos[1]-lloc[1]]);lloc=pos;Selection.update()}}function oppLockCorner(ord){switch(ord){case"n":return"sw";case"s":return"nw";case"e":return"nw";case"w":return"ne";case"ne":return"sw";case"nw":return"se";case"se":return"nw";case"sw":return"ne"}}function createDragger(ord){return function(e){if(options.disabled){return false}if(ord==="move"&&!options.allowMove){return false}btndown=true;startDragMode(ord,mouseAbs(e));e.stopPropagation();e.preventDefault();return false}}function presize($obj,w,h){var nw=$obj.width(),nh=$obj.height();if(nw>w&&w>0){nw=w;nh=w/$obj.width()*$obj.height()}if(nh>h&&h>0){nh=h;nw=h/$obj.height()*$obj.width()}xscale=$obj.width()/nw;yscale=$obj.height()/nh;$obj.width(nw).height(nh)}function unscale(c){return{x:parseInt(c.x*xscale,10),y:parseInt(c.y*yscale,10),x2:parseInt(c.x2*xscale,10),y2:parseInt(c.y2*yscale,10),w:parseInt(c.w*xscale,10),h:parseInt(c.h*yscale,10)}}function doneSelect(pos){var c=Coords.getFixed();if(c.w>options.minSelect[0]&&c.h>options.minSelect[1]){Selection.enableHandles();Selection.done()}else{Selection.release()}Tracker.setCursor(options.allowSelect?"crosshair":"default")}function newSelection(e){if(options.disabled){return false}if(!options.allowSelect){return false}btndown=true;docOffset=getPos($img);Selection.disableHandles();Tracker.setCursor("crosshair");var pos=mouseAbs(e);Coords.setPressed(pos);Selection.update();Tracker.activateHandlers(selectDrag,doneSelect);KeyManager.watchKeys();e.stopPropagation();e.preventDefault();return false}function selectDrag(pos){Coords.setCurrent(pos);Selection.update()}function newTracker(){var trk=$("<div></div>").addClass(cssClass("tracker"));if($.browser.msie){trk.css({opacity:0,backgroundColor:"white"})}return trk}if($.browser.msie&&$.browser.version.split(".")[0]==="6"){ie6mode=true}if(typeof obj!=="object"){obj=$(obj)[0]}if(typeof opt!=="object"){opt={}}setOptions(opt);var img_css={border:"none",margin:0,padding:0,position:"absolute",top:0,left:0};var $origimg=$(obj);var img_src=$origimg.attr("src");var promise=new $.Deferred;var $img=$origimg.clone().removeAttr("src").bind("load",function(){promise.resolve()}).attr("src",img_src).removeAttr("id").css(img_css);$img.width($origimg.width());$img.height($origimg.height());presize($img,options.boxWidth,options.boxHeight);var boundx=$img.width(),boundy=$img.height(),$div=$("<div />").width(boundx).height(boundy).addClass(cssClass("holder")).css({position:"relative",backgroundColor:options.bgColor}).append($img);if(options.addClass){$div.addClass(options.addClass)}var $img2=$("<img />").attr("src",img_src).css(img_css).width(boundx).height(boundy),$img_holder=$("<div />").width("100%").height("100%").css({zIndex:310,position:"absolute",overflow:"hidden"}),$hdl_holder=$("<div />").width("100%").height("100%").css("zIndex",320),$sel=$("<div />").css({position:"absolute",zIndex:600}).dblclick(function(){var c=Coords.getFixed();options.onDblClick.call(api,c)}).insertBefore($img).append($img_holder,$hdl_holder);$img_holder.append($img2);if(ie6mode){$sel.css({overflowY:"hidden"})}var bound=options.boundary;var $trk=newTracker().width(boundx+bound*2).height(boundy+bound*2).css({position:"absolute",top:px(-bound),left:px(-bound),zIndex:290}).mousedown(newSelection);var bgcolor=options.bgColor,bgopacity=options.bgOpacity,xlimit,ylimit,xmin,ymin,xscale,yscale,enabled=true,btndown,animating,shift_down;docOffset=getPos($img);promise.done(function(){$div.insertAfter($origimg.hide())});var Touch=function(){function hasTouchSupport(){var support={},events=["touchstart","touchmove","touchend"],el=document.createElement("div"),i;try{for(i=0;i<events.length;i++){var eventName=events[i];eventName="on"+eventName;var isSupported=eventName in el;if(!isSupported){el.setAttribute(eventName,"return;");isSupported=typeof el[eventName]=="function"}support[events[i]]=isSupported}return support.touchstart&&support.touchend&&support.touchmove}catch(err){return false}}function detectSupport(){if(options.touchSupport===true||options.touchSupport===false)return options.touchSupport;else return hasTouchSupport()}return{createDragger:function(ord){return function(e){e.pageX=e.originalEvent.changedTouches[0].pageX;e.pageY=e.originalEvent.changedTouches[0].pageY;if(options.disabled){return false}if(ord==="move"&&!options.allowMove){return false}btndown=true;startDragMode(ord,mouseAbs(e));e.stopPropagation();e.preventDefault();return false}},newSelection:function(e){e.pageX=e.originalEvent.changedTouches[0].pageX;e.pageY=e.originalEvent.changedTouches[0].pageY;return newSelection(e)},isSupported:hasTouchSupport,support:detectSupport()}}();var Coords=function(){var x1=0,y1=0,x2=0,y2=0,ox,oy;function setPressed(pos){pos=rebound(pos);x2=x1=pos[0];y2=y1=pos[1]}function setCurrent(pos){pos=rebound(pos);ox=pos[0]-x2;oy=pos[1]-y2;x2=pos[0];y2=pos[1]}function getOffset(){return[ox,oy]}function moveOffset(offset){var ox=offset[0],oy=offset[1];if(0>x1+ox){ox-=ox+x1}if(0>y1+oy){oy-=oy+y1}if(boundy<y2+oy){oy+=boundy-(y2+oy)}if(boundx<x2+ox){ox+=boundx-(x2+ox)}x1+=ox;x2+=ox;y1+=oy;y2+=oy}function getCorner(ord){var c=getFixed();switch(ord){case"ne":return[c.x2,c.y];case"nw":return[c.x,c.y];case"se":return[c.x2,c.y2];case"sw":return[c.x,c.y2]}}function getFixed(){if(!options.aspectRatio){return getRect()}var aspect=options.aspectRatio,min_x=options.minSize[0]/xscale,max_x=options.maxSize[0]/xscale,max_y=options.maxSize[1]/yscale,rw=x2-x1,rh=y2-y1,rwa=Math.abs(rw),rha=Math.abs(rh),real_ratio=rwa/rha,xx,yy;if(max_x===0){max_x=boundx*10}if(max_y===0){max_y=boundy*10}if(real_ratio<aspect){yy=y2;w=rha*aspect;xx=rw<0?x1-w:w+x1;if(xx<0){xx=0;h=Math.abs((xx-x1)/aspect);yy=rh<0?y1-h:h+y1}else if(xx>boundx){xx=boundx;h=Math.abs((xx-x1)/aspect);yy=rh<0?y1-h:h+y1}}else{xx=x2;h=rwa/aspect;yy=rh<0?y1-h:y1+h;if(yy<0){yy=0;w=Math.abs((yy-y1)*aspect);xx=rw<0?x1-w:w+x1}else if(yy>boundy){yy=boundy;w=Math.abs(yy-y1)*aspect;xx=rw<0?x1-w:w+x1}}if(xx>x1){if(xx-x1<min_x){xx=x1+min_x}else if(xx-x1>max_x){xx=x1+max_x}if(yy>y1){yy=y1+(xx-x1)/aspect}else{yy=y1-(xx-x1)/aspect}}else if(xx<x1){if(x1-xx<min_x){xx=x1-min_x}else if(x1-xx>max_x){xx=x1-max_x}if(yy>y1){yy=y1+(x1-xx)/aspect}else{yy=y1-(x1-xx)/aspect}}if(xx<0){x1-=xx;xx=0}else if(xx>boundx){x1-=xx-boundx;xx=boundx}if(yy<0){y1-=yy;yy=0}else if(yy>boundy){y1-=yy-boundy;yy=boundy}return makeObj(flipCoords(x1,y1,xx,yy))}function rebound(p){if(p[0]<0){p[0]=0}if(p[1]<0){p[1]=0}if(p[0]>boundx){p[0]=boundx}if(p[1]>boundy){p[1]=boundy}return[p[0],p[1]]}function flipCoords(x1,y1,x2,y2){var xa=x1,xb=x2,ya=y1,yb=y2;if(x2<x1){xa=x2;xb=x1}if(y2<y1){ya=y2;yb=y1}return[Math.round(xa),Math.round(ya),Math.round(xb),Math.round(yb)]}function getRect(){var xsize=x2-x1,ysize=y2-y1,delta;if(xlimit&&Math.abs(xsize)>xlimit){x2=xsize>0?x1+xlimit:x1-xlimit}if(ylimit&&Math.abs(ysize)>ylimit){y2=ysize>0?y1+ylimit:y1-ylimit}if(ymin/yscale&&Math.abs(ysize)<ymin/yscale){y2=ysize>0?y1+ymin/yscale:y1-ymin/yscale}if(xmin/xscale&&Math.abs(xsize)<xmin/xscale){x2=xsize>0?x1+xmin/xscale:x1-xmin/xscale}if(x1<0){x2-=x1;x1-=x1}if(y1<0){y2-=y1;y1-=y1}if(x2<0){x1-=x2;x2-=x2}if(y2<0){y1-=y2;y2-=y2}if(x2>boundx){delta=x2-boundx;x1-=delta;x2-=delta}if(y2>boundy){delta=y2-boundy;y1-=delta;y2-=delta}if(x1>boundx){delta=x1-boundy;y2-=delta;y1-=delta}if(y1>boundy){delta=y1-boundy;y2-=delta;y1-=delta}return makeObj(flipCoords(x1,y1,x2,y2))}function makeObj(a){return{x:a[0],y:a[1],x2:a[2],y2:a[3],w:a[2]-a[0],h:a[3]-a[1]}}return{flipCoords:flipCoords,setPressed:setPressed,setCurrent:setCurrent,getOffset:getOffset,moveOffset:moveOffset,getCorner:getCorner,getFixed:getFixed}}();var Shade=function(){var enabled=false,holder=$("<div />").css({position:"absolute",zIndex:240,opacity:0}),shades={top:createShade(),left:createShade().height(boundy),right:createShade().height(boundy),bottom:createShade()};function resizeShades(w,h){shades.left.css({height:px(h)});shades.right.css({height:px(h)})}function updateAuto(){return updateShade(Coords.getFixed())}function updateShade(c){shades.top.css({left:px(c.x),width:px(c.w),height:px(c.y)});shades.bottom.css({top:px(c.y2),left:px(c.x),width:px(c.w),height:px(boundy-c.y2)});shades.right.css({left:px(c.x2),width:px(boundx-c.x2)});shades.left.css({width:px(c.x)})}function createShade(){return $("<div />").css({position:"absolute",backgroundColor:options.shadeColor||options.bgColor}).appendTo(holder)}function enableShade(){if(!enabled){enabled=true;holder.insertBefore($img);updateAuto();Selection.setBgOpacity(1,0,1);$img2.hide();setBgColor(options.shadeColor||options.bgColor,1);if(Selection.isAwake()){setOpacity(options.bgOpacity,1)}else setOpacity(1,1)}}function setBgColor(color,now){colorChangeMacro(getShades(),color,now)}function disableShade(){if(enabled){holder.remove();$img2.show();enabled=false;if(Selection.isAwake()){Selection.setBgOpacity(options.bgOpacity,1,1)}else{Selection.setBgOpacity(1,1,1);Selection.disableHandles()}colorChangeMacro($div,0,1)}}function setOpacity(opacity,now){if(enabled){if(options.bgFade&&!now){holder.animate({opacity:1-opacity},{queue:false,duration:options.fadeTime})
}else holder.css({opacity:1-opacity})}}function refreshAll(){options.shade?enableShade():disableShade();if(Selection.isAwake())setOpacity(options.bgOpacity)}function getShades(){return holder.children()}return{update:updateAuto,updateRaw:updateShade,getShades:getShades,setBgColor:setBgColor,enable:enableShade,disable:disableShade,resize:resizeShades,refresh:refreshAll,opacity:setOpacity}}();var Selection=function(){var awake,hdep=370;var borders={};var handle={};var seehandles=false;var hhs=options.handleOffset;function insertBorder(type){var jq=$("<div />").css({position:"absolute",opacity:options.borderOpacity}).addClass(cssClass(type));$img_holder.append(jq);return jq}function dragDiv(ord,zi){var jq=$("<div />").mousedown(createDragger(ord)).css({cursor:ord+"-resize",position:"absolute",zIndex:zi});if(Touch.support){jq.bind("touchstart",Touch.createDragger(ord))}$hdl_holder.append(jq);return jq}function insertHandle(ord){var hs=options.handleSize;return dragDiv(ord,hdep++).css({top:px(-hhs+1),left:px(-hhs+1),opacity:options.handleOpacity}).width(hs).height(hs).addClass(cssClass("handle"))}function insertDragbar(ord){var s=options.handleSize,h=s,w=s,t=hhs,l=hhs;switch(ord){case"n":case"s":w="100%";break;case"e":case"w":h="100%";break}return dragDiv(ord,hdep++).width(w).height(h).css({top:px(-t+1),left:px(-l+1)})}function createHandles(li){var i;for(i=0;i<li.length;i++){handle[li[i]]=insertHandle(li[i])}}function moveHandles(c){var midvert=Math.round(c.h/2-hhs),midhoriz=Math.round(c.w/2-hhs),north=-hhs+1,west=-hhs+1,east=c.w-hhs,south=c.h-hhs,x,y;if(handle.e){handle.e.css({top:px(midvert),left:px(east)});handle.w.css({top:px(midvert)});handle.s.css({top:px(south),left:px(midhoriz)});handle.n.css({left:px(midhoriz)})}if(handle.ne){handle.ne.css({left:px(east)});handle.se.css({top:px(south),left:px(east)});handle.sw.css({top:px(south)})}if(handle.b){handle.b.css({top:px(south)});handle.r.css({left:px(east)})}}function moveto(x,y){if(!options.shade){$img2.css({top:px(-y),left:px(-x)})}$sel.css({top:px(y),left:px(x)})}function resize(w,h){$sel.width(w).height(h)}function refresh(){var c=Coords.getFixed();Coords.setPressed([c.x,c.y]);Coords.setCurrent([c.x2,c.y2]);updateVisible()}function updateVisible(){if(awake){return update()}}function update(){var c=Coords.getFixed();resize(c.w,c.h);moveto(c.x,c.y);if(options.shade)Shade.updateRaw(c);if(seehandles){moveHandles(c)}if(!awake){show()}options.onChange.call(api,unscale(c))}function setBgOpacity(opacity,force,now){if(!awake&&!force)return;if(options.bgFade&&!now){$img.animate({opacity:opacity},{queue:false,duration:options.fadeTime})}else{$img.css("opacity",opacity)}}function show(){$sel.show();if(options.shade)Shade.opacity(bgopacity);else setBgOpacity(bgopacity,true);awake=true}function release(){disableHandles();$sel.hide();if(options.shade)Shade.opacity(1);else setBgOpacity(1);awake=false;options.onRelease.call(api)}function showHandles(){if(seehandles){moveHandles(Coords.getFixed());$hdl_holder.show()}}function enableHandles(){seehandles=true;if(options.allowResize){moveHandles(Coords.getFixed());$hdl_holder.show();return true}}function disableHandles(){seehandles=false;$hdl_holder.hide()}function animMode(v){if(animating===v){disableHandles()}else{enableHandles()}}function done(){animMode(false);refresh()}if(options.drawBorders){borders={top:insertBorder("hline"),bottom:insertBorder("hline bottom"),left:insertBorder("vline"),right:insertBorder("vline right")}}if(options.dragEdges){handle.t=insertDragbar("n");handle.b=insertDragbar("s");handle.r=insertDragbar("e");handle.l=insertDragbar("w")}if(options.sideHandles){createHandles(["n","s","e","w"])}if(options.cornerHandles){createHandles(["sw","nw","ne","se"])}var $track=newTracker().mousedown(createDragger("move")).css({cursor:"move",position:"absolute",zIndex:360});if(Touch.support){$track.bind("touchstart.jcrop",Touch.createDragger("move"))}$img_holder.append($track);disableHandles();return{updateVisible:updateVisible,update:update,release:release,refresh:refresh,isAwake:function(){return awake},setCursor:function(cursor){$track.css("cursor",cursor)},enableHandles:enableHandles,enableOnly:function(){seehandles=true},showHandles:showHandles,disableHandles:disableHandles,animMode:animMode,setBgOpacity:setBgOpacity,done:done}}();var Tracker=function(){var onMove=function(){},onDone=function(){},trackDoc=options.trackDocument;function toFront(){$trk.css({zIndex:450});if(Touch.support){$(document).bind("touchmove",trackTouchMove).bind("touchend",trackTouchEnd)}if(trackDoc){$(document).bind("mousemove",trackMove).bind("mouseup",trackUp)}}function toBack(){$trk.css({zIndex:290});if(Touch.support){$(document).unbind("touchmove",trackTouchMove).unbind("touchend",trackTouchEnd)}if(trackDoc){$(document).unbind("mousemove",trackMove).unbind("mouseup",trackUp)}}function trackMove(e){onMove(mouseAbs(e));return false}function trackUp(e){e.preventDefault();e.stopPropagation();if(btndown){btndown=false;onDone(mouseAbs(e));if(Selection.isAwake()){options.onSelect.call(api,unscale(Coords.getFixed()))}toBack();onMove=function(){};onDone=function(){}}return false}function activateHandlers(move,done){btndown=true;onMove=move;onDone=done;toFront();return false}function trackTouchMove(e){e.pageX=e.originalEvent.changedTouches[0].pageX;e.pageY=e.originalEvent.changedTouches[0].pageY;return trackMove(e)}function trackTouchEnd(e){e.pageX=e.originalEvent.changedTouches[0].pageX;e.pageY=e.originalEvent.changedTouches[0].pageY;return trackUp(e)}function setCursor(t){$trk.css("cursor",t)}if(!trackDoc){$trk.mousemove(trackMove).mouseup(trackUp).mouseout(trackUp)}$img.before($trk);return{activateHandlers:activateHandlers,setCursor:setCursor}}();var KeyManager=function(){var $keymgr=$('<input type="radio" />').css({position:"fixed",left:"-120px",width:"12px"}),$keywrap=$("<div />").css({position:"absolute",overflow:"hidden"}).append($keymgr);function watchKeys(){if(options.keySupport){$keymgr.show();$keymgr.focus()}}function onBlur(e){$keymgr.hide()}function doNudge(e,x,y){if(options.allowMove){Coords.moveOffset([x,y]);Selection.updateVisible()}e.preventDefault();e.stopPropagation()}function parseKey(e){if(e.ctrlKey){return true}shift_down=e.shiftKey?true:false;var nudge=shift_down?10:1;switch(e.keyCode){case 37:doNudge(e,-nudge,0);break;case 39:doNudge(e,nudge,0);break;case 38:doNudge(e,0,-nudge);break;case 40:doNudge(e,0,nudge);break;case 27:if(options.allowSelect)Selection.release();break;case 9:return true}return false}if(options.keySupport){$keymgr.keydown(parseKey).blur(onBlur);if(ie6mode||!options.fixedSupport){$keymgr.css({position:"absolute",left:"-20px"});$keywrap.append($keymgr).insertBefore($img)}else{$keymgr.insertBefore($img)}}return{watchKeys:watchKeys}}();function setClass(cname){$div.removeClass().addClass(cssClass("holder")).addClass(cname)}function animateTo(a,callback){var x1=parseInt(a[0],10)/xscale,y1=parseInt(a[1],10)/yscale,x2=parseInt(a[2],10)/xscale,y2=parseInt(a[3],10)/yscale;if(animating){return}var animto=Coords.flipCoords(x1,y1,x2,y2),c=Coords.getFixed(),initcr=[c.x,c.y,c.x2,c.y2],animat=initcr,interv=options.animationDelay,ix1=animto[0]-initcr[0],iy1=animto[1]-initcr[1],ix2=animto[2]-initcr[2],iy2=animto[3]-initcr[3],pcent=0,velocity=options.swingSpeed;x=animat[0];y=animat[1];x2=animat[2];y2=animat[3];Selection.animMode(true);var anim_timer;function queueAnimator(){window.setTimeout(animator,interv)}var animator=function(){return function(){pcent+=(100-pcent)/velocity;animat[0]=x+pcent/100*ix1;animat[1]=y+pcent/100*iy1;animat[2]=x2+pcent/100*ix2;animat[3]=y2+pcent/100*iy2;if(pcent>=99.8){pcent=100}if(pcent<100){setSelectRaw(animat);queueAnimator()}else{Selection.done();if(typeof callback==="function"){callback.call(api)}}}}();queueAnimator()}function setSelect(rect){setSelectRaw([parseInt(rect[0],10)/xscale,parseInt(rect[1],10)/yscale,parseInt(rect[2],10)/xscale,parseInt(rect[3],10)/yscale]);options.onSelect.call(api,unscale(Coords.getFixed()))}function setSelectRaw(l){Coords.setPressed([l[0],l[1]]);Coords.setCurrent([l[2],l[3]]);Selection.update()}function tellSelect(){return unscale(Coords.getFixed())}function tellScaled(){return Coords.getFixed()}function setOptionsNew(opt){setOptions(opt);interfaceUpdate()}function disableCrop(){options.disabled=true;Selection.disableHandles();Selection.setCursor("default");Tracker.setCursor("default")}function enableCrop(){options.disabled=false;interfaceUpdate()}function cancelCrop(){Selection.done();Tracker.activateHandlers(null,null)}function destroy(){$div.remove();$origimg.show();$(obj).removeData("Jcrop")}function setImage(src,callback){Selection.release();disableCrop();var img=new Image;img.onload=function(){var iw=img.width;var ih=img.height;var bw=options.boxWidth;var bh=options.boxHeight;$img.width(iw).height(ih);$img.attr("src",src);$img2.attr("src",src);presize($img,bw,bh);boundx=$img.width();boundy=$img.height();$img2.width(boundx).height(boundy);$trk.width(boundx+bound*2).height(boundy+bound*2);$div.width(boundx).height(boundy);Shade.resize(boundx,boundy);enableCrop();if(typeof callback==="function"){callback.call(api)}};img.src=src}function colorChangeMacro($obj,color,now){var mycolor=color||options.bgColor;if(options.bgFade&&supportsColorFade()&&options.fadeTime&&!now){$obj.animate({backgroundColor:mycolor},{queue:false,duration:options.fadeTime})}else{$obj.css("backgroundColor",mycolor)}}function interfaceUpdate(alt){if(options.allowResize){if(alt){Selection.enableOnly()}else{Selection.enableHandles()}}else{Selection.disableHandles()}Tracker.setCursor(options.allowSelect?"crosshair":"default");Selection.setCursor(options.allowMove?"move":"default");if(options.hasOwnProperty("setSelect")){setSelect(options.setSelect);Selection.done();delete options.setSelect}if(options.hasOwnProperty("trueSize")){xscale=options.trueSize[0]/boundx;yscale=options.trueSize[1]/boundy}Shade.refresh();if(options.bgColor!=bgcolor){colorChangeMacro(options.shade?Shade.getShades():$div,options.shade?options.shadeColor||options.bgColor:options.bgColor);bgcolor=options.bgColor}if(bgopacity!=options.bgOpacity){bgopacity=options.bgOpacity;if(options.shade)Shade.refresh();else Selection.setBgOpacity(bgopacity)}xlimit=options.maxSize[0]||0;ylimit=options.maxSize[1]||0;xmin=options.minSize[0]||0;ymin=options.minSize[1]||0;if(options.hasOwnProperty("outerImage")){$img.attr("src",options.outerImage);delete options.outerImage}Selection.refresh()}if(Touch.support)$trk.bind("touchstart",Touch.newSelection);$hdl_holder.hide();interfaceUpdate(true);var api={setImage:setImage,animateTo:animateTo,setSelect:setSelect,setOptions:setOptionsNew,tellSelect:tellSelect,tellScaled:tellScaled,setClass:setClass,disable:disableCrop,enable:enableCrop,cancel:cancelCrop,release:Selection.release,destroy:destroy,focus:KeyManager.watchKeys,getBounds:function(){return[boundx*xscale,boundy*yscale]},getWidgetSize:function(){return[boundx,boundy]},getScaleFactor:function(){return[xscale,yscale]},ui:{holder:$div,selection:$sel}};if($.browser.msie){$div.bind("selectstart",function(){return false})}$origimg.data("Jcrop",api);return api};$.fn.Jcrop=function(options,callback){function attachWhenDone(from){var opt=typeof options==="object"?options:{};var loadsrc=opt.useImg||from.src;var img=new Image;img.onload=function(){function attachJcrop(){var api=$.Jcrop(from,opt);if(typeof callback==="function"){callback.call(api)}}function attachAttempt(){if(!img.width||!img.height){window.setTimeout(attachAttempt,50)}else{attachJcrop()}}window.setTimeout(attachAttempt,50)};img.src=loadsrc}this.each(function(){if($(this).data("Jcrop")){if(options==="api"){return $(this).data("Jcrop")}else{$(this).data("Jcrop").setOptions(options)}}else{attachWhenDone(this)}});return this};$.Jcrop.defaults={allowSelect:true,allowMove:true,allowResize:true,trackDocument:true,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:.6,bgFade:false,borderOpacity:.4,handleOpacity:.5,handleSize:7,handleOffset:5,aspectRatio:0,keySupport:true,cornerHandles:true,sideHandles:true,drawBorders:true,dragEdges:true,fixedSupport:true,touchSupport:null,shade:false,boxWidth:0,boxHeight:0,boundary:2,fadeTime:400,animationDelay:20,swingSpeed:3,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){},onDblClick:function(){},onRelease:function(){}}})(jQuery);(function(jQuery){jQuery.each(["backgroundColor","borderBottomColor","borderLeftColor","borderRightColor","borderTopColor","color","outlineColor"],function(i,attr){jQuery.fx.step[attr]=function(fx){if(fx.state==0){fx.start=getColor(fx.elem,attr);fx.end=getRGB(fx.end)}fx.elem.style[attr]="rgb("+[Math.max(Math.min(parseInt(fx.pos*(fx.end[0]-fx.start[0])+fx.start[0]),255),0),Math.max(Math.min(parseInt(fx.pos*(fx.end[1]-fx.start[1])+fx.start[1]),255),0),Math.max(Math.min(parseInt(fx.pos*(fx.end[2]-fx.start[2])+fx.start[2]),255),0)].join(",")+")"}});function getRGB(color){var result;if(color&&color.constructor==Array&&color.length==3)return color;if(result=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(color))return[parseInt(result[1]),parseInt(result[2]),parseInt(result[3])];if(result=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(color))return[parseInt(result[1]),parseInt(result[2]),parseInt(result[3])];if(result=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(color))return[parseFloat(result[1])*2.55,parseFloat(result[2])*2.55,parseFloat(result[3])*2.55];if(result=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(color))return[parseInt(result[1],16),parseInt(result[2],16),parseInt(result[3],16)];if(result=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(color))return[parseInt(result[1]+result[1],16),parseInt(result[2]+result[2],16),parseInt(result[3]+result[3],16)];return colors[jQuery.trim(color).toLowerCase()]}function getColor(elem,attr){var color;do{color=jQuery.curCSS(elem,attr);if(color!=""&&color!="transparent"||jQuery.nodeName(elem,"body"))break;attr="backgroundColor"}while(elem=elem.parentNode);return getRGB(color)}var colors={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0]}})(jQuery);(function($){var floor=Math.floor;var coef=1e5;var Convert=function($img){this._rel_rect={left:0,top:0,width:$img.width(),height:$img.height()}};Convert.prototype.toArrayString=function(r){return"["+r.left+","+r.top+","+r.width+","+r.height+"]"};Convert.prototype.toScreen=function(r){var ri=this._rel_rect;var w=ri.width;var h=ri.height;return{left:ri.left+w*r.left/coef,top:ri.top+h*r.top/coef,width:w*r.width/coef,height:h*r.height/coef}};Convert.prototype.toStore=function(r){var ri=this._rel_rect;var w=ri.width;var h=ri.height;return{left:floor((r.left-ri.left)*coef/w),top:floor((r.top-ri.top)*coef/h),width:floor(r.width*coef/w),height:floor(r.height*coef/h)}};Convert.prototype.screenRelative=function(r){return{left:r.left-this._rel_rect.left,top:r.top-this._rel_rect.top,width:r.width,height:r.height}};Convert.prototype.screenAbsolute=function(r){return{left:r.left+this._rel_rect.left,top:r.top+this._rel_rect.top,width:r.width,height:r.height}};Convert.prototype.twoPoints=function(r){return[r.left,r.top,r.left+r.width,r.top+r.height]};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}if(!("Areas"in Fotki.Classes)){Fotki.Classes.Areas={}}Fotki.Classes.Areas.Convert=Convert})(jQuery);(function($){var Models={};Models.UserData=function(uid,login,title,userpic){this.uid=uid;this.login=login;this.title=title;this.userpic=userpic};Models.TextData=function(text){this.text=text};Models.Area=function(rect,tagger,can_edit,face_id,data,guesses){this.rect=rect;this.tagger=tagger;this.can_edit=can_edit;this.face_id=face_id;this.data=data;this.guesses=guesses};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}if(!("Areas"in Fotki.Classes)){Fotki.Classes.Areas={}}Fotki.Classes.Areas.Models=Models})(jQuery);(function($){var templ=Fotki.Classes.Areas.Templates;var state={normal:"normal",active:"active",waiting:"waiting"};var mode={empty:"empty",labeled:"labeled",guess:"guess"};var classes={state_hover:"b-area_state_hover",state_active:"b-area_state_active",state_waiting:"b-area_state_waiting",state_readonly:"b-area_state_readonly",mode_labeled:"b-area_mode_labeled",mode_guess:"b-area_mode_guess"};var area_type={me:"me",login:"login",uid:"uid",text:"text"};var Area=function(model,screen_rect){this._hint_hide_timeout=150;this._area=model;this._rect=screen_rect;this._mode=mode.empty;this.is_blank=false;this.events=$("<div/>");this._hideTimeout=null;this._init();this._setState(state.normal)};Area.area_type=area_type;Area.events=$("<div/>");Area.prototype.getRect=function(){return this._rect};Area.prototype.updateRect=function(rect){var r=rect;this._rect=rect;this.$elem.css({left:r.left+"px",top:r.top+"px",width:r.width+"px",height:r.height+"px"});this.events.trigger("resize")};Area.prototype.getRaw=function(){return this._area};Area.prototype.getData=function(){return this._area.data};Area.prototype.getGuesses=function(){return this._area.guesses};Area.prototype.canEdit=function(){return this._area.can_edit};Area.prototype.getType=function(){return this._type};Area.prototype.nothingToRemove=function(){return!this._area||!this._area.data};Area.prototype.isEmpty=function(){return this._mode===mode.empty||this._mode===mode.guess};Area.prototype.showHint=function(){if(!this.$hint||this._state!==state.normal){return}this._preventHide();Area.events.trigger("force-hide-hint",[this]);Fotki.help.popup.alignTo(this.$hint,this.$elem);this.$hint.show();this.$elem.toggleClass(classes.state_hover,true)};Area.prototype.hideHint=function(){if(this.$hint){this.$hint.hide()}if(this.$elem){this.$elem.toggleClass(classes.state_hover,false)}};Area.prototype._init=function(){var data=this._area.data;var $elem=templ.create("area");this.$elem=$elem;$elem.data("area",this);if(!this.canEdit()){$elem.addClass(classes.state_readonly)}this._updateData();this.updateRect(this._rect);$elem.bind("mouseenter",function(){$elem.toggleClass(classes.state_hover,true)});$elem.bind("mouseleave",this.hideHintDelayed.bind(this));Area.events.trigger("created",[this.$elem]);Area.events.bind("force-hide-hint",function(evt,source){if(source!==this){this.hideHint()}}.bind(this))};Area.prototype._updateData=function(){var data=this._area.data;if(data){this._clearGuess();if(data.text){this._setText();this._changeMode()}else if(data.login){this._setUser();this._changeMode()}}else if(this._area.guesses&&this._area.guesses.length===1){this._setGuess();this._mode=mode.guess;this.$elem.addClass(classes.mode_guess)}};Area.prototype.removeGuess=function(){this._clearGuess();this.$elem.toggleClass(classes.mode_guess,false)};Area.prototype._clearGuess=function(){this._mode=mode.empty;if(this.$guess){this.$guess.remove()}};Area.prototype.startEdit=function(){if(this._state!==state.normal){return}this._setState(state.active)};Area.prototype.stopEdit=function(){this._setState(state.normal)};Area.prototype._setUser=function(data){return this._setData(data,area_type.uid)};Area.prototype._setText=function(data){return this._setData(data,area_type.text)};Area.prototype._setData=function(data,new_type){if(data){this._area.data=data}this._type=new_type;this._recreateHint();this.is_blank=false;return this};Area.prototype._setGuess=function(){this._createGuess();Fotki.Classes.Area.events.one("overlay:start-edit",function(){Fotki.help.popup.alignTo(this.$guess,this.$elem)}.bind(this));return this};Area.prototype._changeMode=function(){if(this._mode===mode.empty){this._mode=mode.new_labeled;this.$elem.addClass(classes.mode_labeled)}else if(this._mode===mode.labeled){this._mode=mode.labeled_changed;this.$elem.addClass(classes.mode_labeled)}};Area.prototype.remove=function(animate){var remove_callback=function(){this.$elem.remove();this.$elem=null}.bind(this);if(typeof animate=="undefined"){animate=true}this._preventHide();if(this.$hint){this.$hint.remove()}if(this.$guess){this.$guess.remove()}this.events.trigger("removed");this.events.unbind();this.events.remove();if(animate){this.$elem.fadeOut(remove_callback)}else{remove_callback()}};Area.prototype.reset=function(){this._setState(state.normal)};Area.prototype.onRemove=function(evt){evt.preventDefault();evt.stopPropagation();if(this._state===state.waiting){return}if(this.isEmpty()){this.events.trigger("remove");return}this._setState(state.active);Area.events.trigger("remove-confirm",[this])};Area.prototype.removeConfirmed=function(ban){this.events.trigger("remove",[ban])};Area.prototype.save=function(model){this._area=model;this._updateData();this.events.trigger("saved")};Area.prototype.onSave=function(evt,data,force_user){if(evt){evt.preventDefault();evt.stopPropagation()}if(this._state===state.waiting){return}this.events.trigger("save",[data,force_user])};Area.prototype._recreateHint=function(){var hint_type;if(this.$hint){this.$hint.remove()}switch(this._type){case area_type.me:case area_type.login:case area_type.uid:hint_type="user_hint";break;default:hint_type="text_hint";break}this.$hint=templ.create(hint_type,this._area.data);this.$hint.bind("mouseenter",this._preventHide.bind(this)).bind("mouseleave",this.hideHintDelayed.bind(this));this.$hint.hide();this.$hint.appendTo(document.body)};Area.prototype._createGuess=function(){var template_name;var guess=this._area.guesses[0];if(guess.text){template_name="guess_text_hint"}else{template_name="guess_user_hint"}this.$guess=templ.create(template_name,guess);$(".js-guess-wrong",this.$guess).bind("click",function(evt){Area.events.trigger("guess:wrong",[this])}.bind(this));$(".js-guess-accept",this.$guess).bind("click",function(evt){this.onSave(evt,guess)}.bind(this));this.$guess.appendTo(document.body)};Area.prototype.hideHintDelayed=function(){this._hideTimeout=setTimeout(this.hideHint.bind(this),this._hint_hide_timeout)};Area.prototype._preventHide=function(){if(this._hideTimeout){clearTimeout(this._hideTimeout)}};Area.prototype.freeze=function(){this._setState(state.waiting)};Area.prototype.unfreeze=function(trigger_operation_failed){this._setState(state.normal);if(trigger_operation_failed){Area.events.trigger("operation_failed")}};Area.prototype._setState=function(new_state){if(this._state===new_state){return}this._reset();this._state=new_state;if(new_state===state.active){this.hideHint();this.$elem.toggleClass(classes.state_active,true)}else if(new_state===state.waiting){this.$elem.toggleClass(classes.state_waiting,true)}};Area.prototype._reset=function(){this.$elem.removeClass(classes.state_active);this.$elem.removeClass(classes.state_waiting)};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}Fotki.Classes.Area=Area})(jQuery);(function($){var max=Math.max;var templ=Fotki.Classes.Areas.Templates;var get_area=function(evt){return $(evt.target).closest(".b-area").data("area")};var state={view:"view",detecting:"detecting",edit:"edit",editing:"editing",remove:"remove",removing:"removing"};var classes={state_view:"b-areas_state_view",state_detecting:"b-areas_state_detecting",state_edit:"b-areas_state_edit",state_editing:"b-areas_state_editing",state_remove:"b-areas_state_remove",state_removing:"b-areas_state_removing",body_state_edit:"b-body_state_edit"};var Overlay=function($root,$element,options,controller){this._crop_correction=0;this._minSize=[30,30];this.$root=$root;this.$element=$element;this.options=options;this.controller=controller;this.$img=controller.$img;this._createPositionedOverlay();this._createRemoveConfirmForm();this.areas=[];this._selected=null;this.$crop=null;Fotki.Classes.Area.events.bind("created",this._showArea.bind(this)).bind("remove-confirm",this._areaRemoveConfirm.bind(this)).bind("operation_failed",function(){if(this._state===state.editing){var area=this._selected;this._restoreState();this._startEditArea(null,area)}else{this._restoreState()}}.bind(this)).bind("guess:wrong",function(evt,area){this._startEditArea(evt,area)}.bind(this)).bind("hint:show",function(){$(".js-image-bottom").removeClass("g-hidden")}).bind("hint:hide",function(){$(".js-image-bottom").toggleClass("g-hidden",true)});this.controller.list.events.bind("detect",function(){this._setState(state.detecting)}.bind(this));this.controller.list.events.bind("detected",function(){this._setState(state.edit)}.bind(this));this.controller.list.events.bind("stop-edit",function(){this._setState(state.view)}.bind(this));this._prev_state=state.view;this._setState(state.view);this._initSuggest();$(".js-preview:not(.b-areas_state_view) .js-img-link").live("click",function(evt){evt.preventDefault()});$(".js-preview.b-areas_state_view .b-area").live("mouseenter",function(evt){get_area(evt).showHint()});$(".js-preview.b-areas_state_edit .b-area").live("mouseenter",function(evt){get_area(evt).showHint()});$(".js-preview.b-areas_state_edit .b-area:not(.b-area_state_readonly)").live("click",this._startEditArea.bind(this));$(".js-preview.b-areas_state_view .b-area .js-remove").live("click",function(evt){this._startRemove(evt,get_area(evt))}.bind(this));$(".js-preview.b-areas_state_edit .b-area .js-remove").live("click",function(evt){this._startRemove(evt,get_area(evt))}.bind(this));$(".js-guess-popup").live("mouseenter",function(evt){$(evt.target).closest(".js-guess-popup").addClass("b-guess-popup_hover")});$(".js-guess-popup").live("mouseleave",function(evt){$(evt.target).closest(".js-guess-popup").removeClass("b-guess-popup_hover")})};Overlay.prototype._createPositionedOverlay=function(){var $img=this.$img;var offset=$img.position();var height=$img.height();var $overlay=$("<div/>").addClass("js-areas-overlay").css({position:"relative",margin:"0 auto",width:$img.width(),height:height});var $href=$img.closest(".js-img-link");if($href.length>0){$href.parent().append($overlay);$overlay.append($href)}else{this.$img.wrap($overlay)}$overlay=this.$overlay=this.$img.closest(".js-areas-overlay");this.$overlay_container=$overlay.find("a");if(this.$overlay_container.length===0){this.$overlay_container=$overlay}this.$element.css("height",height)};Overlay.prototype._startRemove=function(evt,area){area.onRemove(evt);Lego.cp(106,71390,"deletetag.click")};Overlay.prototype._createRemoveConfirmForm=function(){var form=templ.init("remove_hint").toggleClass("g-hidden",true).appendTo(document.body);form.find(".js-remove-confirm").bind("click",function(){form.trigger("confirmed")});form.find(".js-remove-cancel").bind("click",function(){form.trigger("canceled")});this.$remove_form=form};Overlay.prototype._areaRemoveConfirm=function(evt,area){var form=this.$remove_form;var ban=form.find("#js-ban");var ban_raw=form.find(".js-ban-raw");this._onCancel();this._setState(state.remove);area.hideHint();ban.removeAttr("checked");ban_raw.removeClass("g-hidden");if(area.getRaw().tagger.uid===this.options.current_user.uid){ban_raw.addClass("g-hidden")}form.bind("confirmed.once",function(){form.unbind(".once");form.addClass("g-hidden");area.removeConfirmed(ban.is(":checked"));this._setState(state.removing)}.bind(this)).bind("canceled.once",function(){form.unbind(".once");form.addClass("g-hidden");area.reset();this._restoreState()}.bind(this)).removeClass("g-hidden").show();Fotki.help.popup.alignTo(form,area.$elem)};Overlay.prototype.addArea=function(area){var areas=this.areas;areas.push(area);area.events.one("removed",function(){for(var i=0;i<areas.length;i++){if(areas[i]===area){areas.splice(i,1);this._areasNumberChanged();break}}if(this._state===state.removing){this._restoreState()}}.bind(this));this._areasNumberChanged()};Overlay.prototype._initSuggest=function(){this._suggest=new Fotki.Classes.UserSuggest(this.options);this._suggest.events.bind("suggest:save",function(evt,data,force_user){this._selected.onSave(evt,data,force_user)}.bind(this)).bind("suggest:cancel",this._onCancel.bind(this))};Overlay.prototype._onCancel=function(){var rect;var selected=this._selected;var convert=this.controller.convert;if(!selected){return}rect=this.controller.getClientAreaRect(selected.getRaw().rect);selected.removeGuess();selected.updateRect(rect);this._forgetSelected(true);this._suggest.hide();this._restoreState()};Overlay.prototype._forgetSelected=function(remove_if_blank){if(!this._selected){return}this._selected.stopEdit();this._selected.events.unbind(".selected");if(remove_if_blank&&this._selected.is_blank){this._selected.remove(false)}this._selected=null};Overlay.prototype._showArea=function(evt,area_element){this.$overlay_container.append(area_element)};Overlay.prototype._startEditArea=function(evt,area){var suggest=this._suggest;if(evt){evt.preventDefault();evt.stopPropagation()}if(this._state!==state.edit){return}area=area||get_area(evt);this._forgetSelected();this._selected=area;this._setState(state.editing);this._makeResizable(area);area.startEdit();suggest.show(area.getData(),area.$elem,area.getGuesses());area.events.one("remove.selected",function(){if(this._selected===area){suggest.hide()}}.bind(this));area.events.bind("resize.selected",function(){suggest.align(area.$elem)});area.events.bind("saved.selected",function(){this._forgetSelected();this._restoreState()}.bind(this));Fotki.Classes.Area.events.trigger("force-hide-hint")};Overlay.prototype._makeResizable=function(area){this.$crop=$.Jcrop(this.$img.selector,{setSelect:this._getRectForCrop(area.getRect()),onChange:function(c){if(c.x===c.x2&&c.y===c.y2){}else{area.updateRect(this._getRectFromCrop(c))}}.bind(this),onSelect:function(c){var r=this._getRectFromCrop(c);r=this.expandToMinSize(r);if(this.$crop){this.$crop.animateTo([r.left,r.top,r.left+r.width,r.top+r.height])}area.updateRect(r)}.bind(this),onRelease:function(){this._onCancel()}.bind(this)})};Overlay.prototype._getRectForCrop=function(rect){var correction=this._crop_correction;var convert=this.controller.convert;var r=convert.twoPoints(convert.screenRelative(rect));r[2]+=correction;r[3]+=correction;return r};Overlay.prototype._getRectFromCrop=function(crop){var convert=this.controller.convert;var correction=this._crop_correction;var r=convert.screenAbsolute({left:crop.x,top:crop.y,width:crop.w,height:crop.h});r.width-=correction;r.height-=correction;return r};Overlay.prototype._disableResizers=function(){if(this.$crop){this.$crop.destroy()}this.$crop=null};Overlay.prototype._enableGlobalResizer=function(){this.$crop=$.Jcrop(this.$img.selector,{onSelect:this._createNewArea.bind(this)})};Overlay.prototype._createNewArea=function(){var selected=this.$crop.tellSelect();var r=this._getRectFromCrop(selected);r=this.expandToMinSize(r);var rect=this.controller.convert.toStore(r);var a=new Fotki.Classes.Areas.Models.Area(rect,null,true);var area=this.controller.createArea(a);area.is_blank=true;this.addArea(area);this._startEditArea(null,area)};Overlay.prototype.expandToMinSize=function(r){var c={left:r.left+r.width/2,top:r.top+r.height/2};var w=max(r.width,this._minSize[0]);var h=max(r.height,this._minSize[1]);return{left:c.left-w/2,top:c.top-h/2,width:w,height:h}};Overlay.prototype.loadAreas=function(areas){$.each(areas,function(index,area){var a=this.controller.createArea(area);this.addArea(a)
}.bind(this))};Overlay.prototype._setState=function(new_state){var $root=this.$root;if(this._state===new_state){return}this._reset();this._savePrevState();this._state=new_state;switch(this._state){case state.view:$root.addClass(classes.state_view);this._setViewState();this.controller.list.setViewMode();break;case state.detecting:$root.addClass(classes.state_detecting);break;case state.edit:$root.addClass(classes.state_edit);$(document.body).addClass(classes.body_state_edit);this._enableGlobalResizer();this.controller.list.setEditMode();Fotki.Classes.Area.events.trigger("overlay:start-edit");break;case state.editing:$root.addClass(classes.state_editing);break;case state.remove:$root.addClass(classes.state_remove);break;case state.removing:$root.addClass(classes.state_removing);break}};Overlay.prototype._savePrevState=function(){if(this._state===state.view||this._state===state.edit){this._prev_state=this._state}};Overlay.prototype._reset=function(){$(document.body).removeClass(classes.body_state_edit);this.$root.removeClass(classes.state_view).removeClass(classes.state_detecting).removeClass(classes.state_edit).removeClass(classes.state_editing).removeClass(classes.state_remove).removeClass(classes.state_removing);this._disableResizers()};Overlay.prototype._setViewState=function(){var area;var areas=this.areas;if(this._selected){this._onCancel()}for(var i=areas.length-1;i>=0;i--){area=areas[i];if(area.isEmpty()){area.remove()}}};Overlay.prototype._restoreState=function(){this._setState(this._prev_state)};Overlay.prototype._areasNumberChanged=function(){Fotki.Classes.Area.events.trigger(this.areas.length>0?"hint:hide":"hint:show")};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}if(!("events"in Fotki)){Fotki.events=$("<div/>")}Fotki.Classes.Overlay=Overlay})(jQuery);(function($){var templ=Fotki.Classes.Areas.Templates;var User=Fotki.Classes.Areas.Models.UserData;var TextLabel=Fotki.Classes.Areas.Models.TextData;var classes={item_readonly:"b-user-list-item_mode_readonly"};var List=function(options){this._editing=false;this.options=options;this.$list=$(".js-areas-list");this.$button=$(".js-detect");this.events=$("<div/>");this._updateList();var getItemData=function(evt){return $(evt.target).closest(".b-user-list-item").data("item")};$(".js-preview.b-areas_state_view .js-detect").live("click",this._onDetect.bind(this));$(".js-preview.b-areas_state_edit .js-detect").live("click",this._onComplete.bind(this));$(".js-preview.b-areas_state_view .b-user-list-item").live("mouseenter",function(evt){getItemData(evt).area.showHint()});$(".js-preview.b-areas_state_edit .b-user-list-item").live("mouseenter",function(evt){getItemData(evt).area.showHint()});$(".js-preview.b-areas_state_view .b-user-list-item").live("mouseleave",function(evt){getItemData(evt).area.hideHintDelayed()});$(".js-preview.b-areas_state_edit .b-user-list-item").live("mouseleave",function(evt){getItemData(evt).area.hideHintDelayed()});$(".js-preview.b-areas_state_view .b-user-list-item .js-remove").live("click",function(evt){getItemData(evt).area.onRemove(evt)});$(".js-preview.b-areas_state_edit .b-user-list-item .js-remove").live("click",function(evt){getItemData(evt).area.onRemove(evt)})};List.prototype.addAreas=function(){var areas=Fotki.utils.toArray(arguments);$.each(areas,function(index,area){var $item=this._createItem(area);this.$list.append($item)}.bind(this));this._updateList()};List.prototype._createItem=function(area){var $item;var data=area.getData()||{};if(data.text){$item=templ.create("text_list_item",data)}else if(data.login){$item=templ.create("user_list_item",data)}else{$item=templ.create("empty_list_item")}$item.data("item",{item:this,area:area});this._initItem($item,area);return $item};List.prototype._initItem=function($item,area){if(!area.canEdit()){$item.addClass(classes.item_readonly);$item.find(".js-remove").remove()}area.events.bind("saved.list",function(){this._update($item,area)}.bind(this)).bind("removed.list",function(){this._remove($item)}.bind(this))};List.prototype._update=function($item,area){area.events.unbind(".list");var $new_item=this._createItem(area);var $prev=$item.prev();$item.remove();$new_item.insertAfter($prev);this._updateList()};List.prototype._remove=function($item){$item.fadeOut(function(){$item.remove();this._updateList()}.bind(this))};List.prototype._updateList=function(){this._updateButtonText();this.$button.removeClass("g-hidden");this.$list.find(".js-list-title").toggleClass("g-hidden",!this._hasAreas());this._placeCommas()};List.prototype._onDetect=function(evt){evt.preventDefault();Lego.cp(106,71390,"detectfaces.click");if(this.options.redirect_to_oferta){window.location.href="/oferta.xml?retpath="+encodeURIComponent(window.location.href);return}this.events.trigger("detect")};List.prototype._onComplete=function(evt){evt.preventDefault();Lego.cp(106,71390,"done.click");this.events.trigger("stop-edit")};List.prototype._placeCommas=function(){this.$list.find(".js-comma:visible").remove();this.$list.find(".js-area-list-item:visible:not(li:last)").each(function(i,item){templ.create("comma_list_item").insertAfter(item)})};List.prototype.setEditMode=function(){if(!this._editing){Lego.cp(106,71390,"done.show")}this._editing=true;this.$button.find(".js-text").html(this.options.text.stop_edit);this.$button.toggleClass("b-form-button_state_edit",true)};List.prototype.setViewMode=function(){if(this._editing){Lego.cp(106,71390,"detectfaces.show")}this._editing=false;this._updateButtonText();this.$button.toggleClass("b-form-button_state_edit",false);this.$button.find("input").blur()};List.prototype._updateButtonText=function(){if(this._editing){return}var button_label=this._hasAreas()?this.options.text.add_more:this.options.text.detect;this.$button.find(".js-text").html(button_label)};List.prototype._hasAreas=function(){return $(".js-area-list-item:visible").length>0};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}Fotki.Classes.AreasList=List})(jQuery);(function($){var area_type=Fotki.Classes.Area.area_type;var utils=Fotki.utils;var Action=function(area,controller){this.url="/actions/ajax-modify-areas.xml";this.find_user_url="/actions/ajax-find-user-by-login.xml";this.area=area;this.controller=controller};Action.prototype.init=function(){var controller=this.controller;this.convert=controller.convert;this.base_params={author_uid:controller.options.author_uid,image_id:controller.options.image_id,ticket:controller.options.ticket}};Action.prototype._findArea=function(areas,rect){var r;for(var i=0;i<areas.length;i++){r=areas[i].rect;if(r.left===rect.left&&r.top===rect.top&&r.width===rect.width&&r.height===rect.height){return areas[i]}}};Action.prototype.isTextData=function(){return!!this.data.text};Action.prototype.getData=function(){var data=this.data;var area=this.area;var convert=this.convert;var raw=area.getRaw();var rect=convert.toStore(area.getRect());this.new_rect=rect;var label=data.uid||data.text;label=(label+"").substring(0,255);var type;if(data.uid){type=area_type.uid}else if(data.login){type=area_type.login}else if(data.text){type=area_type.text}else{type=area_type.me}return $.extend({old_area:convert.toArrayString(raw.rect),new_area:convert.toArrayString(rect),face_id:raw.face_id,area_type:type,label:label,nc:Fotki.utils.nc()},this.base_params)};Action.prototype._sanitize=function(area){var d=area.data;if(d.text){d.text=utils.unescape(d.text)}if(d.uid){d.login=utils.unescape(d.login);d.title=utils.unescape(d.title)}};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}if(!("Areas"in Fotki.Classes)){Fotki.Classes.Areas={}}Fotki.Classes.Areas.BaseAction=Action})(jQuery);(function($){var Action=function(area,ban,controller){this.area=area;this.data=area.getData();this.ban=ban;this.controller=controller;this.init()};Action.prototype=new Fotki.Classes.Areas.BaseAction;Action.prototype.prepare=function(){var area=this.area;area.hideHint();area.stopEdit();area.freeze()};Action.prototype.startRemove=function(){var data;this.prepare();if(this.area.nothingToRemove()){this.finalizeRemove();return}data=this.getData();delete data.new_area;if(this.ban){data.ban_uid=this.area.getRaw().tagger.uid}$.ajax({type:"POST",url:this.url,dataType:"json",data:data,success:this._onSuccess.bind(this),error:this._onError.bind(this)})};Action.prototype.finalizeRemove=function(){this.area.remove()};Action.prototype.removeFailed=function(){alert("Не удалось удалить выбранную область.");var area=this.area;area.unfreeze(true)};Action.prototype._onSuccess=function(data,text_status,req){var success=!data.error;if(success){this.finalizeRemove()}else{this.removeFailed()}};Action.prototype._onError=function(req,text_status,error){this.removeFailed()};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}if(!("Areas"in Fotki.Classes)){Fotki.Classes.Areas={}}Fotki.Classes.Areas.RemoveAction=Action})(jQuery);(function($){var errors={userNotFound:"user not found",accessDenied:"access denied",userIsBanned:"user is banned",imageIsBlocked:"image is blocked",contestParticipant:"contest participant",imageNotFound:"image not found",userUntaggable:"tagged user blocked areas",shadyUser:"shady user"};var Action=function(area,data,force_user,controller){this.area=area;this.data=data;this.force_user=force_user;this.controller=controller;this.init()};Action.prototype=new Fotki.Classes.Areas.BaseAction;Action.prototype.startSave=function(){var data;this.area.freeze();this._trySave()};Action.prototype._trySave=function(){var data=this.getData();if(this.area.isEmpty()){data.old_area=data.new_area}data.force_user=this.force_user;$.ajax({type:"POST",url:this.url,dataType:"json",data:data,success:this._onSuccess.bind(this),error:this._onError.bind(this)})};Action.prototype.finalize=function(model){var area=this.area;this._sanitize(model);area.unfreeze();area.save(model);area.hideHint();area.stopEdit()};Action.prototype.failed=function(error){if(error){if(error===errors.userUntaggable){this._confirmAndRetry("Пользователь запретил отмечать себя на фото. Сохранить эту отметку как текст?",function(){this.data.text=this.data.login||this.data.title||this.data.text||this.data.uid;delete this.data.uid;delete this.data.login}.bind(this));return}}alert("Не удалось сохранить выбранную область.");this.area.unfreeze(true)};Action.prototype._confirmAndRetry=function(question,before_retry){if(!confirm(question)){this.area.unfreeze(true);return}before_retry();this._trySave()};Action.prototype._onSuccess=function(data,text_status,req){var area;var success=!data.error;if(success){area=this._findArea(data.areas,this.new_rect);if(!area){this.failed();return}this.finalize(area)}else{this.failed(data.error)}};Action.prototype._onError=function(req,text_status,error){this.failed()};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}if(!("Areas"in Fotki.Classes)){Fotki.Classes.Areas={}}Fotki.Classes.Areas.SaveAction=Action})(jQuery);(function($){var Actions=Fotki.Classes.Areas;var Models=Fotki.Classes.Areas.Models;var rect=Fotki.rect;var Areas=function(){this._faces=null;this._get_faces_url="/actions/get-faces.xml";var $root=$(".js-preview");this.$element=$(".js-areas");if(!this.$element.length){return}this.$img=$("#fotka-view div.img img");this.options=this.$element.get(0).onclick();this.sortAreas(this.options.areas);Fotki.Classes.Areas.Templates.setCurrentUserID(this.options.current_user.uid).setAuthor({uid:this.options.author_uid,login:this.options.author_login});this.convert=new Fotki.Classes.Areas.Convert(this.$img);this.list=new Fotki.Classes.AreasList(this.options);this.overlay=new Fotki.Classes.Overlay($root,this.$element,this.options,this);this.overlay.loadAreas(this.options.areas);this.list.events.bind("detect",this._detectAreas.bind(this))};Areas.prototype.removeArea=function(area,ban){new Actions.RemoveAction(area,ban,this).startRemove()};Areas.prototype.saveArea=function(area,data,force_user){new Actions.SaveAction(area,data,force_user,this).startSave()};Areas.prototype._detectAreas=function(evt){evt.preventDefault();this.detect(this._merge.bind(this))};Areas.prototype.detect=function(callback){if(this._faces){callback(this._faces);return}$.ajax({url:this._get_faces_url,type:"GET",data:{uid:this.options.author_uid,id:this.options.image_id,nc:Fotki.utils.nc()},dataType:"json",success:function(data){this._onDetected(data,callback)}.bind(this),error:function(){this._onDetected(null,callback)}.bind(this)})};Areas.prototype._onDetected=function(data,callback){this._faces=[];if(data&&data.areas){this._faces=data.areas;this._facesPreProcess(this._faces);this.sortAreas(this._faces)}callback(this._faces)};Areas.prototype._facesPreProcess=function(faces){var face;var guess;for(var i=0;i<faces.length;i++){face=faces[i];if(!face.guesses||face.guesses.length===0){return}for(var j=0;j<face.guesses.length;j++){guess=face.guesses[j];if(guess.title){guess.title=Fotki.utils.unescape(guess.title)}}}};Areas.prototype.createArea=function(area_data){var rect=this.getClientAreaRect(area_data.rect);var area=new Fotki.Classes.Area(area_data,rect);area.events.bind("remove",function(evt,ban){this.removeArea(area,ban)}.bind(this)).bind("save",function(evt,data,force_user){this.saveArea(area,data,force_user)}.bind(this));this.list.addAreas(area);return area};Areas.prototype.getClientAreaRect=function(raw_rect){var rect=this.convert.toScreen(raw_rect);return this.overlay.expandToMinSize(rect)};Areas.prototype._merge=function(areas){var area;var a,b;var old=this.overlay.areas;var add=true;var something_added=false;for(var i=0;i<areas.length;i++){add=true;area=areas[i];a=this.getClientAreaRect(area.rect);for(var j=0;j<old.length;j++){b=old[j].getRect();if(rect.getIntersectionRate(a,b)>=.9){add=false;break}}if(add){var copy=$.extend({},area);this.overlay.addArea(this.createArea(copy));something_added=true}}this.list.events.trigger("detected")};Areas.prototype.sortAreas=function(areas){areas.sort(function(a,b){if(a.rect.top===b.rect.top){return a.rect.left-b.rect.left}return a.rect.top-b.rect.top})};if(!("Fotki"in window)){window.Fotki={}}if(!("Classes"in Fotki)){Fotki.Classes={}}Fotki.Classes.ImageAreas=Areas})(jQuery);(function($){var request_timeout=3e4;var intervaler=Fotki.utils.getIncrementalIntervalGenerator();var unloaded=false;window.onbeforeunload=function(){unloaded=true};var SaveImage=function(){};SaveImage.prototype.run=function(){var that=this;var promise=this.promise=new $.Deferred;var req=$.ajax({url:"/actions/disk/save-image-start.xml",type:"GET",data:{author:Fotki.data.image.author,id:Fotki.data.image.id,ticket:Fotki.data.ticket},dataType:"json",timeout:request_timeout});req.done(function(data){if(data&&data.id){that.task_id=data.id;intervaler.reset();that._pingStatus()}else if(data&&data.error){promise.reject(data)}else{promise.reject({can_retry:true})}});req.fail(function(){if(unloaded){return}promise.reject({can_retry:true})});return promise};SaveImage.prototype._pingStatus=function(){var that=this;var req=$.ajax({url:"/actions/disk/save-image-progress.xml",type:"GET",data:{id:this.task_id,ticket:Fotki.data.ticket,nc:Fotki.utils.nc()},dataType:"json",timeout:request_timeout});req.done(function(data){if(data&&data.done&&data.url){that.promise.resolve(data)}else if(data&&!data.done){setTimeout(function(){that._pingStatus()},intervaler.get())}else{that.promise.reject(data)}});req.fail(function(){if(unloaded){return}that.promise.reject({can_retry:true})})};var SaveAlbum=function(){var $node=this.$node=$(".js-dsi")};SaveAlbum.prototype.run=function(){var that=this;var promise=this.promise=new $.Deferred;var req=$.ajax({url:"/actions/disk/save-album-start.xml",type:"GET",data:{author:Fotki.data.image.author,id:Fotki.data.album.id,ticket:Fotki.data.ticket},dataType:"json",timeout:request_timeout});req.done(function(data){if(data&&data.result){that.result=data.result;that._pingStatus()}else if(data&&data.error){promise.reject(data)}else{promise.reject({can_retry:true})}});req.fail(function(){if(unloaded){return}promise.reject({can_retry:true})});return promise};SaveAlbum.prototype._pingStatus=function(){var that=this;var req=$.ajax({url:"/actions/disk/save-album-progress.xml",type:"GET",data:{author:Fotki.data.image.author,id:Fotki.data.album.id,ticket:Fotki.data.ticket,nc:Fotki.utils.nc()},dataType:"json",timeout:request_timeout});req.done(function(data){if(data&&data.done&&data.url&&(!data.error||data.error!=="")){that.promise.resolve(data)}else if(data&&!data.done){that.$node.trigger("task.progress",data);setTimeout(function(){that._pingStatus()},3e3)}else{that.promise.reject(data)}});req.fail(function(data){if(unloaded){return}that.promise.reject({can_retry:true})})};SaveAlbum.prototype.ping=function(){var that=this;var promise=this.promise=new $.Deferred;that._pingStatus();return that.promise};Fotki.disk={};Fotki.disk.SaveImage=SaveImage;Fotki.disk.SaveAlbum=SaveAlbum})(jQuery);(function(){var enableButton=function($elem){$elem.bem("b-form-button").setMod("disabled","no")};var disableButton=function($elem){$elem.bem("b-form-button").setMod("disabled","yes")};var showStatus=function($elem){$elem.toggleClass("g-hidden",false)};var init=function(){var $elem=$(".js-dsi");if(!$elem.length){return}var $btn=$(".js-dsi-btn",$elem);var btnType=$btn.find(".b-form-button__input").attr("value");var _status={active:$(".js-dsi-status_active",$elem),failed:$(".js-dsi-status_failed",$elem),success:$(".js-dsi-status_success",$elem)};var setStatus=function(status,message){$(".js-dsi-status",$elem).toggleClass("g-hidden",true);var $nodes=_status[status];if(!$nodes){return}var $text=$nodes.find(".js-dsi-status__text");var $progress=$nodes.find(".js-dsi-status__progress");if(message&&$text&&$progress){$text.html(message);$progress.css("width",message)}else if(message&&$text){$text.html(message)}showStatus($nodes)};var task;var statusMessage;if("save-album"===btnType){task=new Fotki.disk.SaveAlbum;statusMessage="Альбом сохранён ";var pingPromise=task.ping();var session=false;pingPromise.done(function(result){if(session){setTimeout(function(){setStatus("active","100%")},0);setTimeout(function(){setStatus("active","0%");setStatus("success",statusMessage+'в папку «<a href="'+result.url+'" target="_blank">'+result.folder+"</a>»");if(result.can_retry){enableButton($btn)}},3e3)}});pingPromise.fail(function(result){if(session){setStatus("active","0%");setStatus("failed",result.error);if(result.can_retry){enableButton($btn)}}});$elem.on("task.progress",function(e,result){disableButton($btn);setStatus("active",Math.floor(result.progress)+"%");session=session||true})}else{task=new Fotki.disk.SaveImage;statusMessage="Фотография сохранена "}$btn.bind("click",function(){disableButton($btn);setStatus("active");if("save-album"!==btnType){setStatus("active","10%");var timeoutImageProgress=setTimeout(function(){setStatus("active","42%")},1e3)}var promise=task.run();promise.done(function(result){setStatus("active","100%");setTimeout(function(){setStatus("active","0%");setStatus("success",statusMessage+'в папку «<a href="'+result.url+'" target="_blank">'+result.folder+"</a>»");if(result.can_retry){enableButton($btn)}},3e3)});promise.fail(function(result){result=result||{};setStatus("active","0%");setStatus("failed",result.error);if(timeoutImageProgress){clearTimeout(timeoutImageProgress)}if(result.can_retry){enableButton($btn)}});if("save-album"===btnType){Lego.cp(106,72220)}else{Lego.cp(106,72219)}})};$(init)})();(function($){var Page=function(){};Page.prototype.init=function(){$(document).ready(this.initControls.bind(this));return this};Page.prototype.initControls=function(){var el=$(".js-album").get(0);if(!el){return}var params=this.params=el.onclick();var $li=$("#move_album_link").parents("span");var default_width=$li.width();var page=this;$("#move_album_link").bind("click",function(e){var $this=$(this);page.loadAlbums();$this.hide();$li.addClass("basic-ie");$("#move_album").show();$("#moveToAlbum").focus()});$("#moveToAlbum").bind("change",function(e){var $this=$(this);if($this.val()){$("#action_form").attr("action","/actions/album-move.xml").submit()}});$("#moveToAlbum").bind("blur",function(e){var $this=$(this);$li.removeClass("basic-ie");$("#move_album").hide();$("#move_album_link").show()});$("#album_delete").bind("click",function(e){if(confirm(params.strings["album-view: photo_delete_confirm"])){$("#action_form").attr("action","/actions/album-delete.xml").submit()}});this.level=0};Page.prototype.loadAlbums=function(){var params=this.params;if($("#moveToAlbum option").length<=1){$.ajax({type:"GET",url:"/actions/ajax-albums-list.xml",dataType:"json",data:{author:params.author},success:function(data){$("#moveToAlbum").append($.map(data.albums,this.albumsToOption.bind(this)).join())}.bind(this),error:function(data){$("#moveToAlbum option").text(params.strings["album-view: error_load_album_list"])}.bind(this)})}};Page.prototype.albumsToOption=function(album,i){var paddingString="&#160;&#160;";var params=this.params;var output=[];if(album.id!=params.album_id&&this.level<4){var num_images=album.num_images>0?" ("+params.strings["common: total_photo"].replace(/%%/,album.num_images)+")":"";var attr='value="'+album.id+'"';if(album.id==params.album_parent_id||this.level>3){attr+='disabled="disabled"'}var padding="";while(padding.length/paddingString.length<this.level){padding=padding+paddingString}output=["<option "+attr+" >"+padding+album.title+num_images+"</option>"];if(album.albums!==undefined){this.level++;output=$.merge(output,$.map(album.albums,this.albumsToOption.bind(this)));this.level--}}return output};Fotki=window.Fotki||{};Fotki.page=(new Page).init()})(jQuery);